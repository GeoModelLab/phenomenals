---
title: "Trait Prediction with PhenoMeNals"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Trait Prediction with PhenoMeNals}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## üì¶ These are the packages we will use....
```{r table, include=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, include=TRUE, warning=FALSE, message=FALSE}
library(phenomenals)

library(kableExtra) # for tables
library(plotly) # for plotting
library(ggplot2) # for plotting
library(dplyr) # for formatting 
library(stringr) # for formatting
library(forcats) # for formatting
library(lubridate) # for dates

```

## üß† Goal

This vignette shows how to use runPhenomenals() to model grapevine traits (e.g., yield) using eco-physiological memory signals computed along a phenological timeline.

We‚Äôll use the demo datasets included in the package:

    colliOrientali ‚Äî daily weather data

    targetSample ‚Äî observed target traits (e.g., yield)

    phenomenalsParameters ‚Äî model parameters
    
## üì• Input parameters
### 1. weather_data
The very same structure as in [phenologyCalibration()](/articles/phenology-calibration.html)

### 2. target_data
A data frame of phenological and/or target trait observations. An example is the  [`targetSample`](../reference/targetSample.html) dataset
Required columns:

| Column      | Description                                                          | Example     |
| ----------- | -------------------------------------------------------------------- | ----------- |
| `Site`      | Site name (must match `Site` in `weather_data`)                      | `napa`      |
| `Latitude`  | Latitude of the site (decimal degrees)                               | `38.3`      |
| `Longitude` | Longitude of the site (decimal degrees)                              | `122.0`     |
| `Variety`   | Variety name                                                         | `CabernetS` |
| `Year`      | Harvest year                                                         | `1994`      |
| `Variable`  | Trait name to be modeled (e.g., `"yield"`, `"brix"`, `"malic_acid"`) | `brix`      |
| `Value`     | Observed value for the trait                                         | `23.2`      |

Notes:

    This table is used to link phenological signals with observed traits.
    Multiple traits can be provided per site and variety by using different Variable values.
    The Value column must be numeric and non-empty.
    Internal normalization and alignment with climate/BBCH cycles is handled automatically.

### 3. phenomenalsParameters
A nested list of model parameters (typically from [`phenomenalsParameters`](../reference/phenomenalsParameters.html)). Each parameter includes calibration metadata and value ranges.
This is the very same structure than in [phenologyCalibration()](/articles/phenology-calibration.html)

##### 4. Other arguments

| Argument                      | Description                                                                                       | Default          |
| ----------------------------- | ------------------------------------------------------------------------------------------------- | ---------------- |
| `start_year`                  | First year of simulation or calibration                                                           | `2000`           |
| `end_year`                    | Last year of simulation or calibration                                                            | `2025`           |
| `sites`                       | Sites to include (character vector or `"all"`)                                                    | `"all"`          |
| `varieties`                   | Varieties to include (character vector or `"all"`)                                                | `"all"`          |
| `timestep`                    | Time resolution of `weather_data`: `"daily"` or `"hourly"`                                        | `"daily"`        |
| `target_traits`               | Traits to model (e.g., `"yield"`, `"brix"`)                                                       | `"yield"`        |
| `rolling_window`              | Window size (in days) for smoothing phenological signals                                          | `5`              |
| `evaluation_range`            | List of cycle percentage ranges to evaluate (0‚Äì200 scale; 0‚Äì100 dormancy, 101‚Äì200 growing season) | `list(c(0,200))` |
| `multicollinearity_threshold` | Threshold above which correlated predictors are dropped                                           | `0.8`            |
| `max_phenomenals`             | Max number of predictors to retain per model after stepwise regression                            | `4`              |
| `bin_size`                    | Resolution (% cycle) to bin phenological signals                                                  | `1`              |

## üì¶ Load the data

```{r load-data}
data(colliOrientali)
data(targetSample)
parameters <- phenomenalsParameters
```

## üîç Inspect the inputs
```{r inspect-inputs}
kable(head(colliOrientali), caption = "Example weather data") %>%
  kable_styling(font_size = 11)
kable(head(targetSample), caption = "Example target data") %>%
  kable_styling(font_size = 11)
```


## ‚öôÔ∏è Run runPhenomenals()
```{r run-calibration}
phenomenals_result <- runPhenomenals(
     weather_data = colliOrientali,
     target_data = targetSample,
     phenomenalsParameters = phenomenalsParameters,
     start_year = 2010,
     end_year = 2020,
     sites = "ColliOrientali",
     varieties = "Carmenere",
     timestep = 'daily',
     rolling_window = 5,
     target_traits = c('yield'),
     evaluation_range = list(c(0,400)),
     multicollinearity_threshold=0.8,
     max_phenomenals=4,
     bin_size=1)
     
```

This will:

- Use the small demo weather and BBCH dataset  
- Calibrate parameters only for *Carmenere* at *ColliOrientali*  
- Run 100 iterations (feel free to increase for real applications, the higher the iterations, the longer the time to relax a bit)
- Takes around one minute 

## üî• Correlation heatmap across the two-year cycle

```{r correlations-heatmap, fig.width=8, fig.height=12}
# Start from runPhenomenals output
correlations <- phenomenals_result$selection$correlations %>%                  # pick trait
  mutate(
    # Collapse 0‚Äì200 (Year -1) + [skip] + 200‚Äì300 (Year 0) into a continuous 0‚Äì200 scale
    cyclePerc_remap = ifelse(cyclePerc > 200, cyclePerc - 100, cyclePerc)
  )

# Build compact labels for major phenophases
pheno_labels <- correlations %>%
  mutate(label = case_when(
    between(cyclePerc, 5, 15)                 ~ "ENDO",
    between(cyclePerc, 45, 55)                ~ "ECO",
    relative_year == "year_1" & BBCHPhase %in% 5:15   ~ "DIFF",
    relative_year == "year_1" & BBCHPhase %in% 50:59  ~ "DEV",
    relative_year == "year_1" & BBCHPhase >= 10       ~ "SETUP",
    relative_year == "year_0" & BBCHPhase %in% 5:10   ~ "BUD",
    relative_year == "year_0" & BBCHPhase %in% 11:69  ~ "FLO",
    relative_year == "year_0" & BBCHPhase %in% 71:79  ~ "VER",
    relative_year == "year_0" & BBCHPhase >= 81       ~ "MAT",
    TRUE ~ NA_character_
  )) %>%
  filter(!is.na(label)) %>%
  group_by(target_trait, relative_year, label) %>%
  summarise(Completion = median(Completion, na.rm = TRUE), .groups = "drop") %>%
  mutate(
    block        = ifelse(relative_year == "year_1", 0, 2),
    x_position   = Completion + (block - 1) * 100 + 100,
    x_position_r = ifelse(x_position > 200, x_position - 100, x_position)
  )

ggplot(correlations,
  aes(x = cyclePerc_remap, y = fct_rev(interaction(site,variety)), fill = cor)
) +
  geom_tile(color = "grey95", linewidth = 0.2) +
  geom_vline(xintercept = 200, linetype = 1, color = "black", size = 0.4) + # visual separator
  scale_fill_gradient2(
    low = "gold3", mid = "white", high = "darkslateblue",
    midpoint = 0, limits = c(-.8, .8), name = "Pearson r"
  ) +
  geom_text(data = pheno_labels,
            aes(x = x_position_r, y = -1.4, label = label),
            inherit.aes = FALSE, angle = 90, vjust = 0.3, hjust = 0, size = 3) +
  annotate("text", x = 140, y = -.7, label = "Year -1", size = 3, fontface = "italic") +
  annotate("text", x = 246, y = -.7, label = "Year 0",  size = 3, fontface = "italic") +
  facet_wrap(~ ecoFunction, ncol = 1) +
  labs(x = NULL, y = NULL) +
  guides(fill = guide_colorbar(
    title.position = "top", title.hjust = 0.5, barwidth = 20, barheight = 0.8
  )) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "top",
    panel.grid = element_blank(),
    axis.text.x = element_blank(),
    strip.text = element_text(size = 16),
    plot.margin = margin(5, 5, 5, 5)
  )

```

## üåä Phenomenals dynamics over the cycle (per year)

```{r phenomenals-dynamics, warning=FALSE, fig.width=8, fig.height=10}
# Predictions table (carry both normalized + original scale)
predictions <- phenomenals_result$results$predictions

# Long format (rename AridityF -> DroughtF for consistency)
pred_long <- predictions %>%
  tidyr::pivot_longer(AridityF:WindF, names_to = "phenomenals", values_to = "value") %>%
  mutate(phenomenals = recode(phenomenals, "AridityF" = "DroughtF"))

p<-ggplot(pred_long) +
  stat_summary(fun.data ='mean_se',aes(x = cyclePerc, y = value, fill = phenomenals),
               geom = "ribbon", alpha = 0.5) +
  stat_summary(fun.data ='mean_se', aes(x = cyclePerc, y = value, color = phenomenals),
               geom = "line") +
  facet_grid(phenomenals ~ harvest_year, scales = "free", switch = "y") +
  scale_x_continuous(breaks = seq(200, 400,200)) +
  labs(x = "Phenological completion", y = NULL) +
  theme_minimal(base_size = 12) +
  theme(
    legend.position = "none",
    panel.grid = element_blank(),
    strip.text = element_text(size = 12),
    panel.spacing = unit(0, "lines")
  )
ggplotly(p)
```

## üìà Observed vs simulated trait over years (with R¬≤ in facet titles)

```{r obs-vs-sim, fig.width=9, fig.height=4}
pred <- phenomenals_result$results$predictions
diag <- phenomenals_result$results$diagnostics

# One row per (target, variety, year) w/ diagnostics attached
pred_final <- pred %>%
  group_by(target, variety, harvest_year) %>%
  slice_tail() %>%
  ungroup() %>%
  left_join(
    diag %>% group_by(site, target, variety) %>% slice_tail() %>% ungroup(),
    by = c("site", "variety", "target", "cyclePerc")
  ) %>%
  mutate(
    variety_acr = toupper(str_sub(variety, 1, 3)),
    target = factor(target, levels = c("yield")),
    facet_label = paste0(
      variety_acr, " | R¬≤ CV=", round(R2_loocv, 2),
      " | R¬≤=", round(R2_full, 2)
    )
  )

p<-ggplot(pred_final) +
  geom_col(aes(harvest_year, target_original, color = target,fill=target), linewidth = .5) +
  geom_point(aes(harvest_year, prediction_original, fill = target), fill = 'blue',
             shape = 21, size = 4, stroke = 0.7, alpha = .8) +
  labs(x = NULL, y = NULL) +
  theme_classic(base_size = 12) +
  theme(
    legend.position = "top",
    panel.grid = element_blank(),
    strip.text = element_text(size = 12)
  )
ggplotly(p)
```
