---
title: "Phenology Calibration with PhenoMeNals"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Phenology Calibration}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


## üì¶ These are the packages we will use....
```{r table, include=F, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, include=TRUE, warning=FALSE, message=FALSE}
library(phenomenals)
library(kableExtra)
library(ggplot2)
library(dplyr)
library(lubridate)
library(plotly)
```

## üå± Goal

This vignette demonstrates how to calibrate phenological parameters for a grapevine variety and site using the `phenologyCalibration()` function.

We‚Äôll use sample datasets included in the package:

- `colliOrientali`: daily weather data
- `bbchSample`: observed BBCH stages
- `phenomenalsParameters`: model parameters

## üì• Input parameters
### 1. weather_data
A data frame containing hourly or daily weather data.
The function supports flexible column names (aliases are automatically detected).

| Column                | Aliases (recognized)                       | Units                          | Time step    | Mandatory? |
| --------------------- | ------------------------------------------ | ------------------------------ | ------------ | ---------- |
| `Site`                | site, station, location                    | ‚Äì                              | hourly/daily | **Yes**    |
| `DateTime` / `Date`   | date, datetime, timestamp                  | Date (POSIXct or `yyyy-mm-dd`) | hourly/daily | **Yes**    |
| `Hour`                | hour, hr                                   | 0‚Äì23                           | hourly only  | **Yes**    |
| `Temperature`         | temp, temperature, t2m                     | ¬∞C                             | hourly only  | **Yes**    |
| `Tmax`                | tmax, maxtemp, t2mmax                      | ¬∞C                             | daily   | **Yes**    |
| `Tmin`                | tmin, mintemp, t2mmin                      | ¬∞C                             | daily   | **Yes**    |
| `Precipitation`       | prec, rainfall, rain, prectotcorr          | mm                             | hourly/daily | **Yes**    |
| `RelativeHumidity`    | rh, humidity, relhumidity                  | %                              | hourly | Optional   |
| `RelativeHumidityMax` | rhmax, humiditymax, relhumiditymax, hummax | %                              | daily   | Optional   |
| `RelativeHumidityMin` | rhmin, humiditymin, relhumiditymin, hummin | %                              | daily   | Optional   |
| `WindSpeed`           | wind, ws                                   | m/s                            | hourly/daily | Optional   |
| `Radiation`           | rad, solar, solarrad                       | MJ/m¬≤ (daily) or W/m¬≤ (hourly) | hourly/daily | Optional   |
| `Latitude`            | latitude, lat                              | decimal deg                    | hourly/daily | **Yes**   |

Notes:

    For daily data, only Tmax, Tmin, Precipitation and Latitude are strictly required.
    For hourly data, only Temperature, Precipitation, Hour, DateTime and Latitude are required.
    If RelativeHumidity or Radiation are missing, they are automatically estimated using Tmax, Tmin, precipitation, and latitude.

### 2. referenceBBCH
A data frame containing BBCH phenological observations.
This dataset must include at least the following columns:

| Column      | Description                                      | Example        
| ----------- | ------------------------------------------------ | -------------- 
| `Variety`   | Variety name                                     | CabernetS      |
| `Site`      | Site name (must match sites in `weather_data`)   | ColliOrientali |
| `Latitude`  | Latitude of the site (decimal degrees)           | 44.0           |
| `Longitude` | Longitude of the site (decimal degrees)          | 11.0           |
| `Date`      | Date of observation (format: `yyyy-mm-dd`)       | 2007-04-02     |
| `BBCH`      | BBCH growth stage (numeric code, see BBCH scale) | 8, 65          |


### 3. phenomenalsParameters
A nested list of model parameters. This list is typically loaded from
[`phenomenalsParameters`](../reference/phenomenalsParameters.html) and can be customized.

Structure:
```r
list[
  species][[class]][[parameter]] = list(
    min = <minimum calibration value>,
    max = <maximum calibration value>,
    value = <default value>,
    calibration = <TRUE/FALSE>
  )
```

Notes:

    Parameters marked with calibration = TRUE are optimized during calibration.
    The list is automatically exported to the correct CSV format for the C# engine; you do not need to handle file conversions.

### 4. Other Arguments
| Argument     | Description                                                                                             | Default   |
| ------------ | ------------------------------------------------------------------------------------------------------- | --------- |
| `start_year` | First year of the calibration period                                                                    | `2000`    |
| `end_year`   | Last year of the calibration period                                                                     | `2025`    |
| `sites`      | Site names (must match `Site` in `weather_data` and `referenceBBCH`). Use `"all"` to include all sites. | `"all"`   |
| `varieties`  | Varieties to include (must match `Variety` in `referenceBBCH`). Use `"all"` to include all varieties.   | `"all"`   |
| `iterations` | Number of iterations for the simplex algorithm                                                          | `100`     |
| `timestep`   | Time step of `weather_data` (**"daily"** or **"hourly"**)                                               | `"daily"` |



## üì¶ Load the data

```{r load-data}
data(colliOrientali)
data(bbchSample)
parameters <- phenomenalsParameters
```

## üîç Inspect the inputs
```{r inspect-inputs}
kable(head(colliOrientali), caption = "Example weather data") %>%
  kable_styling(font_size = 10)
kable(head(bbchSample), caption = "Example BBCH data") %>%
  kable_styling(font_size = 10)
```

## ‚öôÔ∏è Run phenologyCalibration()
```{r run-calibration}
calib_result <- phenologyCalibration(
  weather_data = colliOrientali,
  referenceBBCH = bbchSample,
  phenomenalsParameters =phenomenalsParameters,
  start_year = 2006,
  end_year = 2012,
  sites = "ColliOrientali",
  varieties = "Carmenere",
  iterations = 100,
  timestep = "daily"
)
```

This will:

- Use the small demo weather and BBCH dataset  
- Calibrate parameters only for *Carmenere* at *ColliOrientali*  
- Run 100 iterations (feel free to increase for real applications, the higher the iterations, the longer the time to relax a bit)
- Takes around  

## üì§ Inspect output object

```{r result-structure}
str(calib_result, max.level = 1)
```

This helps users see:

- What‚Äôs inside (parameters, phenology)  
- That it‚Äôs a named list  

## üìà Calibrated parameters

```{r view-parameters}
filtered_params <- calib_result$parameters |>
  dplyr::filter(site == "colliorientali", variety == "carmenere")

knitr::kable(filtered_params, caption = "Calibrated parameters for Carmenere at ColliOrientali")
```


All calibrated parameters are within their defined bounds. üéØ

However, if any parameter is very close to its minimum or maximum limit, it's good practice to slightly expand the calibration range and re-run the process. This helps avoid **boundary effects** and ensures the optimization isn‚Äôt artificially constrained.

> üìù Tip: Parameters like `bbch65` or `bbch85` that consistently hit the edge of their range may indicate that your biological assumptions need refining, or that more calibration iterations are needed.

## üçá Phenology curve

This is where you show the time series of predicted BBCH stages over time.
```{r view-results, fig.width = 7, fig.height=3}
p<-ggplot(calib_result$phenology |> 
         mutate(Date=as.Date(Date,format='%m/%d/%Y'),
                year=year(Date)),aes(x=Date)) + 
  geom_line(aes(y=BBCHPhase))+
  geom_point(aes(y=BBCHRef))+
  theme_classic()+
  geom_line(aes(y=ChillState),col='blue4')
ggplotly(p)

```
  

The `phenologyCalibration()` function successfully fits thermal and stress-based parameters
to reproduce observed BBCH stages. This calibrated output can now be passed to
`runPhenomenals()` for trait modeling.
